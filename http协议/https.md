# https

## 对称加密与非对称加密

### 对称加密
服务器和浏览器都用一个密钥对传输内容加密。

### 非对称加密
- 公钥加密，私钥解密。
- 私钥加密，公钥解密。

场景S：
1. 服务器分发公钥给浏览器，自己保留私钥。
2. 服务器用私钥加密信息，传给浏览器，浏览器用公钥解密。
3. 浏览器用公钥加密信息，服务器用私钥解密。

### 对称非对称 一起用
1. 服务器拥有私钥A和公钥A，服务器分发公钥A给浏览器。
2. 浏览器使用对称加密的方法，生成密钥X，用公钥A对密钥X进行加密，发送给服务器。
3. 服务器用私钥A解密，得到密钥X.
4. 浏览器和服务器使用密钥X进行加密数据传输。

### 中间人如何攻击单纯的非对称加密
假设，服务器拥有公钥A和私钥A.
1. 在上述场景S第一步中，中间人劫持了服务器分发的公钥A，替换成自己伪造的公钥B，中间人还有相应的私钥B，然后将公钥B发送给浏览器。
2. 浏览器生成密钥X，用公钥B加密密钥X，然后发送给服务器，但是被中间人劫持，中间人使用私钥B解密，**得到了密钥X**.
3. 回忆上一小节的场景S，服务器和浏览器是要用密钥X来传数据的，现在中间人得到了密钥X，并用密钥A对密钥X进行加密，再把密钥发送给服务器，服务器用私钥A解密，得到密钥X。

这样，中间人就能轻松截获浏览器和服务器之间的所有明文通信。

**问题在哪？**
在于浏览器没有办法判断，自己获得的公钥，到底是不是服务器发给自己的。

## 第三方机构 CA
多了一个第三方机构，简称CA. 

CA拥有非对称加密的公钥C和私钥C.

浏览器拥有公钥C. 这是怎么拥有的？！？！？

服务器使用HTTPS前，向CA机构申请颁发数字证书，数字证书里有证书持有者、证书持有者的公钥等信息。**服务器的公钥A是怎么给CA的？**

### 数字签名制作过程
1. CA对证书明文求信息摘要。
2. 用私钥C对信息摘要进行加密，得到数字签名。

数字签名和证书共同构成数字证书。

### 浏览器验证该证书
1. 浏览器有证书明文T和数字签名S.
2. 用公钥C对数字签名S进行解密，得到S'.
3. 用证书里面的信息摘要算法对明文求hash，得到T'.
4. 如果S'===T'，则表明证书可信。

### HTTPS必须在每次请求中都要先在SSL/TLS层进行握手传输密钥吗？
用session就行。
服务器会为每个浏览器（或客户端软件）维护一个session ID，在TSL握手阶段传给浏览器，浏览器生成好密钥传给服务器后，服务器会把该密钥存到相应的session ID下，之后浏览器每次请求都会携带session ID，服务器会根据session ID找到相应的密钥并进行解密加密操作，这样就不必要每次重新制作、传输密钥了！


### https是怎么做的
1. 服务器向CA申请证书，服务器把自己的公钥A和其他一些信息发给CA，
2. CA把数字证书颁发给服务器
3. 浏览器第一次跟服务器通信，服务器给浏览器发证书，浏览器验证证书。
    1. 浏览器有证书明文T和数字签名S.
    2. 用公钥C对数字签名S进行解密，得到S'.
    3. 用证书里面的信息摘要算法对明文求hash，得到T'.
    4. 如果S'===T'，则表明证书可信。
4. 服务器拥有私钥A和公钥A，服务器分发公钥A给浏览器。
5. 浏览器使用对称加密的方法，生成密钥X，用公钥A对密钥X进行加密，发送给服务器。
6. 服务器用私钥A解密，得到密钥X.
7. 浏览器和服务器使用密钥X进行加密数据传输。
